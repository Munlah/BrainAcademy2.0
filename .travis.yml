language: node_js
node_js:
  - "14"

services:
  - docker

before_install:
  - curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
  - sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
  - sudo apt-get update && sudo apt-get install terraform
  - curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

install:
  - npm install

before_script:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
  - az aks get-credentials --resource-group "brainacademy" --name "brainacademyAKSCluster" --overwrite-existing
  - sudo snap install kubectl --classic

script:
  - npm test
  - docker-compose build ba-munleng
  - docker-compose push ba-munleng
  - kubectl apply -f ba-deployment-munleng.yaml
  - kubectl apply -f ba-service-munleng.yaml
  - kubectl rollout history deployment/ba-deployment
  - kubectl get pods
  - kubectl get services
  - cd ba-terraform
  - terraform init
  - terraform plan
  - terraform apply -auto-approve